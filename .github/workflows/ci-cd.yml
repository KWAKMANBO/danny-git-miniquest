name: Express Blue/Green CI/CD

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Docker Hub Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Build and Push Image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/express-healthcheck:latest .
          docker push ${{ secrets.DOCKER_USERNAME }}/express-healthcheck:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Set up SSH
        env:
          # Secrets를 직접 run 스크립트에 넣지 않고 환경 변수로 매핑하는 것이 훨씬 안전합니다.
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
        run: |
          mkdir -p ~/.ssh
          
          # 환경 변수를 사용하여 키 파일 생성 (따옴표/줄바꿈 문제 해결)
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # 호스트 주소가 있는지 확인 (디버깅 용도)
          if [ -z "$SERVER_HOST" ]; then
            echo "Error: SERVER_HOST secret is empty."
            exit 1
          fi
          
          ssh-keyscan -H "$SERVER_HOST" >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa $SERVER_USER@$SERVER_HOST 'bash -s' << 'ENDSSH'
            set -e
            cd /home/$USER/bluegreen # $USER 변수를 사용하거나 secrets.SERVER_USER 값을 직접 사용
          
            # 현재 실행 중인 컨테이너 확인 (Blue/Green 결정)
            if docker ps | grep -q express-healthcheck-blue; then
              TARGET=green
              STOP=express-healthcheck-blue
            elif docker ps | grep -q express-healthcheck-green; then
              TARGET=blue
              STOP=express-healthcheck-green
            else
              TARGET=blue
              STOP=none
            fi
          
            echo "Deploying to: $TARGET"
          
            # 이미지 Pull 및 실행
            docker compose pull express-healthcheck-$TARGET
            docker compose up -d express-healthcheck-$TARGET
          
            # 헬스 체크
            if [ "$STOP" != "none" ]; then
              echo "Running health check..."
              for i in {1..10}; do
                sleep 2
                if docker exec express-healthcheck-$TARGET curl -s -f http://localhost:3000/health > /dev/null; then
                  echo "Health check passed"
                  break
                elif [ $i -eq 10 ]; then
                  echo "Health check failed. Rolling back..."
                  docker stop express-healthcheck-$TARGET
                  docker compose start $STOP
                  exit 1
                fi
              done
            else
              echo "First deploy — skipping health check"
            fi
          
            echo "Switching Nginx to $TARGET"
            sed -i "s/express-healthcheck-[a-z]*/express-healthcheck-$TARGET/g" nginx.conf
          
            # Nginx 재시작
            if docker ps | grep -q nginx-proxy; then
                docker compose restart nginx-proxy
            else
                docker compose up -d nginx-proxy
            fi
          
            # 이전 컨테이너 중지
            if [ "$STOP" != "none" ]; then
              docker stop $STOP || true
            fi
          ENDSSH